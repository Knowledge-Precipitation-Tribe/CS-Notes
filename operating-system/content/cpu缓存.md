# 什么是CPU缓存
CPU缓存是位于CPU与内存之间的临时数据交换器，它的容量比内存小的多但是交换速度却比内存要快得多。CPU缓存一般直接跟CPU芯片集成或位于主板总线互连的独立芯片上。

![cpucache](./img/cpucache.png)

# 为什么需要CPU缓存
随着多核CPU的发展CPU的频率越来越快，快到主存跟不上，这样在处理器时钟周期内，CPU常常需要等待主存，浪费资源。所以cache的出现就是为了缓解CPU和内存之间速度的不匹配问题CPU缓存通常分成了三个级别：`L1`，`L2`，`L3`。级别越小越接近CPU，所以速度也更快，同时也代表着容量越小。L1是最接近CPU的, 它容量最小（例如：`32K`），速度最快，每个核上都有一个 L1 缓存，L1 缓存每个核上其实有两个 L1 缓存, 一个用于存数据的 L1d Cache（Data Cache），一个用于存指令的 L1i Cache（Instruction Cache）。L2缓存 更大一些（例如：`256K`），速度要慢一些, 一般情况下每个核上都有一个独立的 L2 缓存;  L3 缓存是三级缓存中最大的一级（例如3MB），同时也是最慢的一级, 在同一个CPU插槽之间的核共享一个L3缓存。但是CPU缓存都比较小保存那么一点数据有意义么？这样设计是有意义的，主要是因为[[局部性原理]]。

读取数据过程。就像数据库缓存一样，首先在最快的缓存中找数据，如果缓存没有命中(Cache miss) 则往下一级找, 直到三级缓存都找不到时，向内存要数据。一次次地未命中，代表取数据消耗的时间越长。

计算过程。程序以及数据被加载到主内存；指令和数据被加载到CPU的高速缓；CPU执行指令，把结果写到高速缓存；高速缓存中的数据写回主内存。

# CPU缓存结构
**单核CPU缓存结构如下**：
![](https://img-blog.csdn.net/20160103043551288?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

在单核CPU结构中，L1分成了指令（L1P）和数据（L1D）两部分，而L2则是指令和数据共存。

**多核CPU缓存结构如下**：
![](https://img-blog.csdn.net/20160103044115119?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

多核CPU的结构与单核相似，但是多了所有CPU共享的L3三级缓存。在多核CPU的结构中，L1和L2是CPU私有的，L3则是所有CPU核心共享的。

# 缓存一致性MESI
在多核CPU中，内存中的数据会在多个核心中存在数据副本，某一个核心发生修改操作，就产生了数据不一致的问题。而一致性协议正是用于保证多个CPU cache之间缓存共享数据的一致。至于MESI，则是缓存一致性协议中的一个，到底怎么实现，还是得看具体的处理器指令集。