# 什么是流量控制
发送方不能无脑的一直给接收方发送数据，需要考虑接收方的处理能力，如果接收方处理不过来就会触发重传机制，导致流量的浪费。为了解决上面这个现象，TCP提供了一种机制可以让发送方根据接收方的实际能力控制发送的数据量，这就是所谓的流量控制。

# 如何实现流量控制
接收方每次收到数据包，可以在发送确定报文的时候，同时告诉发送方自己的缓存区还剩余多少是空闲的，我们也把缓存区的剩余大小称之为接收窗口大小，用变量win来表示接收窗口的大小。

发送方收到之后，便会调整自己的发送速率，也就是调整自己发送窗口的大小，当发送方收到接收窗口的大小为0时，发送方就会停止发送数据，防止出现大量丢包情况的发生。

# 如何再次发送数据
当接收窗口大小为0后，发送方停止发送数据，并且开始一个定时器，每隔一段时间就发个窗口探测报文去询问接收方，打听是否可以继续发送数据了，如果可以，接收方就告诉他此时接受窗口的大小；如果接受窗口大小还是为0，则发送方再次刷新启动定时器。窗口探测的次数一般为3次，每次大约30-60秒（不同的实现可能会不一样）。如果3次过后接收窗口还是0的话，有的TCP实现就会发RST报文来中断连接。

# 糊涂窗口综合症
如果接收方太忙了，来不及取走接收窗口里面的数据，就会导致发送方的窗口越来越小，到最后导致如果接收方腾出几个字节告诉发送方现在可以接收几个字节的数据了，那么发送方就会发送这几个字节的数据。TCP+IP报文头有40个字节，为了传输几个字节而构建一个报文显然不太划算。

## 如何解决糊涂窗口
**接收方不告诉小窗口**

当窗口大小小于min(MSS，缓存空间/2) ，也就是小雨MSS与1/2缓存大小中的最小值时，就会向发送方通告窗口为0 ，也就阻止了发送方再发数据过来。

等到接收方处理了一些数据后，窗口大小>= MSS，或者接收方缓存空间有一半可以使用，就可以把窗口打开让发送方发送数据过来。

**发送方避免发送小数据**
使用 Nagle 算法，该算法的思路是延时处理，它满足以下两个条件中的一条才可以发送数据
- 窗口大小>=MSS或者数据大小>=MSS
- 收到之前发送数据的ack包