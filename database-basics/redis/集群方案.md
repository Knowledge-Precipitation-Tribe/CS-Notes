# 集群Cluster
## 什么是redis集群
Redis集群提供一种方式自动将数据分布在多个Redis节点上。Redis集群通过分区来提供一定程度的可用性：即使集群中有一部分节点失效或者无法进行通讯，集群也可以继续处理命令请求。Redis Cluster着眼于解决拓展性，当单个redis内存不足时，使用cluster进行分片存储。

## 集群方案
使用redis cluster部署redis集群，并且采用主从同步，读写分离的形式，redis cluster支持多个master节点，而且每个节点都可以挂载多个slaver，这样redis就可以支持横向拓展。而且设计集群时至少需要考虑到以下两个因素：
- 高可用要求：根据故障转移的原理，至少需要3个主节点才能完成故障转移，且3个主节点不应在同一台物理机上；每个主节点至少需要1个从节点，且主从节点不应在一台物理机上；因此高可用集群至少包含6个节点。
- 数据量和访问量：估算应用需要的数据量和总访问量(考虑业务发展，留有冗余)，结合每个主节点的容量和能承受的访问量(可以通过benchmark得到较准确估计)，计算需要的主节点数量。
- 节点数量限制：Redis官方给出的节点数量限制为1000，主要是考虑节点间通信带来的消耗。在实际应用中应尽量避免大集群；如果节点数量不足以满足应用对Redis数据量和访问量的要求，可以考虑：
	- (1)业务分割，大集群分为多个小集群；
	- (2)减少不必要的数据；
	- (3)调整数据过期策略等。
- 适度冗余：Redis可以在不影响集群服务的情况下增加节点，因此节点数量适当冗余即可，不用太大。

## 数据分片
Redis集群使用数据分片而非一致性哈希来实现：一个Redis集群包含16384个哈希槽，数据库中的每个键都属于这16384个哈希槽的其中一个，集群使用公式CRC16(key)%16384来计算键key属于哪个槽。集群中的每个节点负责处理一部分哈希槽。

这种将哈希槽分布到不同节点的做法使得用户可以很容易地向集群中添加或者删除节点。假设现在集群中有A,B,C,D四个节点，如果我们现在想将新节点E添加到集群中，只需要将A,B,C,D的某些槽移动到E就可以了。同理，如果我们要从集群中移除节点A，那么集群只需要将节点A中的所有哈希槽移动到B,C,D，然后再移除空白（不包含任何哈希槽）的节点A就可以了。

因为将一个哈希槽从一个节点移动到另一个节点不会造成节点阻塞，所以无论是添加新节点还是移除已存在节点，又或者改变某个节点包含的哈希槽数量，都不会造成集群下线。

## ASK错误
当客户端向节点发送关于节点key的命令的时候，若发现节点key不存在于源节点的数据库且源节点正在迁移槽i，则会向客户端返回一个ASK错误。当客户端收到ASK错误后，从中读取目标节点的地址信息，并向目标节点重新发送请求。

# 哨兵 Sensial
## 什么是哨兵
Redis的[[同步机制|]]主从复制模式下，一旦主节点由于故障不能提供服务，需要人工将从节点晋升为主节点，同时还要通知应用方更新主节点地址，对于很多应用场景这种故障处理的方式是无法接受的。可喜的是Redis从2.8开始正式提供了Redis Sentinel（哨兵）架构来解决这个问题。哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。

## 哨兵的主要功能
- 集群监控：负责监控redis master和slave进程是否正常工作
- 消息通知：如果某个redis实例有故障，那么哨兵负责发送消息作为报警通知给管理员
- 故障转移：如果master node挂掉了，会自动转移到slave node上
- 配置中心：如果故障转移发生了，通知client客户端新的master地址

## 哨兵的工作原理
每个哨兵会向其它哨兵、master、slave定时发送消息，以确认对方是否”活”着，如果发现对方在指定时间(可配置)内未回应，则暂时认为对方主观下线。若“哨兵群”中的半数sentinel，都报告某一master没响应，系统才认为该master"彻底死亡"，即客观下线。通过一定的vote算法，从剩下的slave节点中，选一台提升为master，然后自动修改相关配置。

实际上哨兵只是一个运行在特殊模式下的Redis服务器，你可以在启动一个普通Redis服务器时通过给定 --sentinel 选项来启动哨兵(sentinel)。

